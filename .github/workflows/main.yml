name: CI

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Enable TS
        shell: pwsh
        run: |
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -name "UserAuthentication" -Value 1
          Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString -AsPlainText "P@ssw0rd!" -Force)
          
      - name: Set up Udemy Downloader
        shell: cmd
        run: |
          git clone https://github.com/swargaraj/udemy-py.git
          curl -L -o ffmpeg.zip https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip
          curl -L -o N_m3u8DL-RE.zip https://github.com/nilaoda/N_m3u8DL-RE/releases/download/v0.2.1-beta/N_m3u8DL-RE_Beta_win-x64_20240828.zip
          curl -L -o bento4.zip https://www.bok.net/Bento4/binaries/Bento4-SDK-1-6-0-641.x86_64-microsoft-win32.zip

          mkdir temp
          tar -xf ffmpeg.zip -C temp
          tar -xf N_m3u8DL-RE.zip -C temp
          tar -xf bento4.zip -C temp

          ren temp\ffmpeg-master-latest-win64-gpl ffmpeg
          ren temp\N_m3u8DL-RE_Beta_win-x64 N_m3u8DL-RE
          ren temp\Bento4-SDK-1-6-0-641.x86_64-microsoft-win32 bento4

          mkdir bin

          echo Moving renamed directories to "bin" directory...
          xcopy /s /e /y temp\ffmpeg bin\ffmpeg\
          xcopy /s /e /y temp\N_m3u8DL-RE bin\N_m3u8DL-RE\
          xcopy /s /e /y temp\bento4 bin\bento4\

          set newPath=%CD%\bin\ffmpeg\bin;%CD%\bin\N_m3u8DL-RE;%CD%\bin\bento4\bin
          
          setx PATH "%newPath%;%PATH%"
          
          set PATH=%newPath%;%PATH%

          rmdir /s /q temp
          del ffmpeg.zip
          del N_m3u8DL-RE.zip
          del bento4.zip

          (
          echo certifi==2024.8.30
          echo charset-normalizer==3.4.0
          echo colorama==0.4.6
          echo idna==3.10
          echo iso8601==2.1.0
          echo m3u8==6.0.0
          echo markdown-it-py==3.0.0
          echo mdurl==0.1.2
          echo pathvalidate==3.2.1
          echo pycryptodome==3.21.0
          echo Pygments==2.18.0
          echo requests==2.32.3
          echo rich==13.9.2
          echo tqdm==4.66.5
          echo urllib3==2.2.3
          echo webvtt-py==0.5.1
          ) > .\udemy-py\requirements2.txt
          py -m pip install -r .\udemy-py\requirements2.txt

      - name: Download and Extract ngrok for creating secure tunnels
        run: |
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile ".\ngrok.zip"
          Expand-Archive -Path ".\ngrok.zip"
          Remove-Item -Path ".\ngrok.zip"

      - name: Authenticate with ngrok using the provided token
        run: .\ngrok\ngrok.exe authtoken $Env:NGROK_AUTH_TOKEN
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
          
      - name: Start an ngrok tunnel for port 3389 with specified region
        run: .\ngrok\ngrok.exe tcp --region=us-cal-1
          
      - name: Start an ngrok tunnel for port 3389 with specified region
        shell: cmd
        run: .\ngrok\ngrok.exe tcp --region=us-cal-1
